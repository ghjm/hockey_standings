<html>
<head>
    <title>{{ main_title }}</title>
    <meta name="description"
          content="Provides a view of clinching and elimination scenarios in the NHL, like magic/tragic
          numbers, but more visual." />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet" />
    <style>
        :root {
            --bg: #f4f6fb;
            --bg-accent: #e9eef7;
            --ink: #1f2a44;
            --muted: #54617a;
            --border: #d7deea;
        }
        * {
            box-sizing: border-box;
        }
        html, body {
            height: 100%;
        }
        body {
            margin: 0;
            color: var(--ink);
            font-family: "IBM Plex Sans", "Segoe UI", Tahoma, Geneva, sans-serif;
            background:
                radial-gradient(1200px 600px at 10% 10%, rgba(62, 108, 255, 0.18), transparent 60%),
                radial-gradient(900px 500px at 90% 0%, rgba(255, 157, 77, 0.12), transparent 55%),
                linear-gradient(180deg, var(--bg), var(--bg-accent));
        }
        .page {
            min-height: 100vh;
            gap: 16px;
            padding: 28px clamp(16px, 4vw, 40px) 24px;
        }
        .page-header {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 8px 16px;
        }
        .page-title {
            font-size: clamp(24px, 3.2vw, 34px);
            letter-spacing: 0.005em;
            margin: 0;
            font-weight: 500;
            font-family: "Poppins", "IBM Plex Sans", "Segoe UI", Tahoma, Geneva, sans-serif;
            color: #1a2442;
            text-shadow: 0 1px 0 rgba(255, 255, 255, 0.7), 0 6px 14px rgba(15, 30, 60, 0.12);
        }
        .updated-at {
            font-size: 13px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        .graph-shell {
            overflow: visible;
        }
        .graph-shell-inner {
            width: 100%;
            min-width: 600px;
            height: max(800px, 92vh);
        }
        .page-footer {
            border-top: 1px solid var(--border);
            padding-top: 10px;
            color: var(--muted);
            font-size: 12px;
        }
        .page-footer small {
            display: block;
            line-height: 1.4;
        }
        @media (hover: none) {
            .cursor-pointer {
                pointer-events: none !important;
            }
        }
        @media only screen and (min-device-width: 600px) {
            .explanatory-text {
                max-width: 600px
            }
        }
        @media only screen and (max-device-width: 600px) {
            .graph-shell-inner {
                min-width: 0;
                height: max(640px, 88vh);
            }
        }
    </style>
    <meta charset=utf-8" />

    {% if google_analytics_id %}
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id={{ google_analytics_id }}"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', '{{ google_analytics_id }}');
    </script>
    {% endif %}

</head>
<body>
    <div class="page">
        <header class="page-header">
            <h1 class="page-title">{{ main_title }}</h1>
            <div class="updated-at">Last Updated: {{ last_update_time }}</div>
        </header>
        <section class="graph-shell">
            <div class="graph-shell-inner">
                {{ main_graph }}
            </div>
        </section>
        <script>
            (function () {
                var mobileYAxisLabels = {{ yaxis_mobile_labels | safe }};
                var baseDtick = null;
                var suppressNextUnhover = false;
                function applyResponsiveLayout() {
                    if (!window.Plotly) return;
                    var plot = document.querySelector(".plotly-graph-div");
                    if (!plot) return;
                    if (!baseDtick) {
                        baseDtick = {};
                        Object.keys(plot.layout || {}).forEach(function (key) {
                            if (key.indexOf("xaxis") === 0 && plot.layout[key] && plot.layout[key].dtick) {
                                baseDtick[key] = plot.layout[key].dtick;
                            }
                        });
                    }
                    var isMobile = window.matchMedia("(max-width: 720px)").matches;
                    var tickUpdates = {};
                    if (baseDtick) {
                        Object.keys(baseDtick).forEach(function (key) {
                            tickUpdates[key + ".dtick"] = isMobile ? baseDtick[key] * 2 : baseDtick[key];
                        });
                    }
                    if (mobileYAxisLabels && mobileYAxisLabels.length) {
                        mobileYAxisLabels.forEach(function (entry) {
                            if (!entry.axis) return;
                            if (isMobile) {
                                tickUpdates[entry.axis + ".tickvals"] = entry.tickvals;
                                tickUpdates[entry.axis + ".ticktext"] = entry.ticktext;
                            } else {
                                tickUpdates[entry.axis + ".tickvals"] = null;
                                tickUpdates[entry.axis + ".ticktext"] = null;
                            }
                        });
                    }
                    if (isMobile) {
                        Plotly.relayout(plot, Object.assign({
                            legend: {
                                orientation: "v",
                                bgcolor: "rgba(255, 255, 255, 0.9)",
                                bordercolor: "rgba(19, 0, 66, 0.4)",
                                borderwidth: 1,
                                tracegroupgap: 0,
                                x: 0.5,
                                xanchor: "center",
                                y: 1.08,
                                yanchor: "bottom"
                            },
                            margin: { t: 90, r: 10, l: 60, b: 40 }
                        }, tickUpdates));
                    } else {
                        Plotly.relayout(plot, Object.assign({
                            legend: {
                                orientation: "v",
                                bgcolor: "rgba(255, 255, 255, 0.9)",
                                bordercolor: "rgba(19, 0, 66, 0.4)",
                                borderwidth: 1,
                                tracegroupgap: 0,
                                x: 1.02,
                                xanchor: "left",
                                y: 1,
                                yanchor: "top"
                            },
                            margin: { t: 40, r: 170, l: 60, b: 40 }
                        }, tickUpdates));
                    }
                }
                var resizeTimer;
                function onResize() {
                    clearTimeout(resizeTimer);
                    resizeTimer = setTimeout(applyResponsiveLayout, 150);
                }
                window.addEventListener("load", applyResponsiveLayout);
                window.addEventListener("resize", onResize);

                function isDataTarget(event) {
                    if (!event.target || !event.target.closest) return false;
                    return !!event.target.closest(".point, .points, .bar, .bars, .scatter, .traces");
                }

                function shouldUnhoverFromEvent(event) {
                    if (suppressNextUnhover) return false;
                    return !isDataTarget(event);
                }

                function attachUnhoverHandlers() {
                    var plot = document.querySelector(".plotly-graph-div");
                    if (!plot || !window.Plotly || !window.Plotly.Fx) return;
                    if (plot.__unhoverHandlersAttached) return;
                    plot.__unhoverHandlersAttached = true;

                    plot.on && plot.on("plotly_click", function () {
                        suppressNextUnhover = true;
                        setTimeout(function () { suppressNextUnhover = false; }, 0);
                    });
                    plot.on && plot.on("plotly_legendclick", function () {
                        Plotly.Fx.unhover(plot);
                    });

                    document.addEventListener("pointerdown", function (event) {
                        if (shouldUnhoverFromEvent(event)) {
                            Plotly.Fx.unhover(plot);
                        }
                    });
                }

                window.addEventListener("load", attachUnhoverHandlers);
            })();
        </script>
        <footer class="page-footer explanatory-text">
            <small>
                Data feed provided courtesy of, and is copyrighted by, the NHL.
            </small>
        </footer>
    </div>
</body>
</html>
